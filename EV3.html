<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BreatheEarth – simple AQI</title>
<meta name="description" content="Single-serving site showing local PM2.5 air quality.">
<style>
  :root{ --bg:#e8fdea; --fg:#0f2518; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; display:grid; place-items:center; text-align:center;
    font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--fg); transition:background .25s ease,color .25s ease; padding:24px;
  }
  .card{max-width:720px;width:100%;background:rgba(255,255,255,.75);backdrop-filter:blur(8px);padding:28px 22px;border-radius:18px}
  h1{margin:0 0 .25rem;font-size:clamp(1.8rem,2.2vw+1rem,2.6rem)}
  .sub{opacity:.8;margin:0 0 1rem}
  .status{font-size:clamp(1.8rem,4vw,2.6rem);font-weight:900;letter-spacing:-.02em;margin:.4rem 0}
  .pm{opacity:.9;font-weight:700}
  .meta{opacity:.8;margin-top:.25rem}
  .err{color:#b01212;font-weight:800;margin-top:.6rem}
  .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  input{flex:1 1 260px;min-width:230px;padding:10px 12px;border-radius:10px;border:1px solid #cfe0d9;background:#fff;outline:none}
  button{padding:10px 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer;background:#0f2518;color:#fff}
  .hint{opacity:.75;font-size:.9rem;margin-top:8px}
</style>
</head>
<body>
  <main class="card" role="main" aria-live="polite">
    <h1>BreatheEarth</h1>
    <p class="sub">The air you breathe connects us all.</p>

    <div id="place">Ready.</div>
    <div class="status" id="status">Click “Check my air quality”.</div>
    <div class="pm" id="pm">PM2.5: — µg/m³</div>
    <div class="meta" id="time">—</div>
    <div class="err" id="err"></div>

    <div class="row" style="margin-top:14px">
      <button id="checkBtn">Check my air quality</button>
    </div>

    <div class="row" style="margin-top:8px">
      <input id="city" placeholder="Or type a city (e.g., Dhaka, London, Austin)" />
      <button id="cityBtn">Search city</button>
    </div>

    <div class="hint">Categories: <b>GOOD ≤ 12.0</b>, <b>BAD ≤ 35.4</b>, <b>WORSE &gt; 35.4</b> (PM2.5 µg/m³)</div>
  </main>

<script>
/* -------- Endpoints (no API key) -------- */
const AIR = (lat, lon) => `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto`;
const REV1 = (lat, lon) => `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1&language=en&format=json`;
const REV2 = (lat, lon) => `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
const GEO  = (q)       => `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=en&format=json`;

/* -------- UI refs -------- */
const el = {
  place:  document.getElementById('place'),
  status: document.getElementById('status'),
  pm:     document.getElementById('pm'),
  time:   document.getElementById('time'),
  err:    document.getElementById('err'),
  check:  document.getElementById('checkBtn'),
  city:   document.getElementById('city'),
  cityBtn:document.getElementById('cityBtn'),
};

/* -------- Helpers -------- */
function setTheme(word){
  if(word === 'GOOD'){ document.documentElement.style.setProperty('--bg','#91e2a0'); document.documentElement.style.setProperty('--fg','#0a2617'); }
  else if(word === 'BAD'){ document.documentElement.style.setProperty('--bg','#ffe56e'); document.documentElement.style.setProperty('--fg','#2a2107'); }
  else { document.documentElement.style.setProperty('--bg','#ff9d4a'); document.documentElement.style.setProperty('--fg','#3a1b00'); }
}
function categorize(pm){ return pm <= 12.0 ? 'GOOD' : pm <= 35.4 ? 'BAD' : 'WORSE'; }
function fmt(iso){ try{ return new Date(iso).toLocaleString([], {hour:'2-digit',minute:'2-digit',month:'short',day:'2-digit'}); } catch(_){ return ''; } }
async function j(url, opt={}){ const r = await fetch(url, {cache:'no-store', ...opt}); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }
function indexClosestToNow(times){
  const now = Date.now(); let bestI = 0, best = Infinity;
  for(let k=0;k<times.length;k++){ const d = new Date(times[k]).getTime(); const diff = Math.abs(d - now); if(diff < best){ best = diff; bestI = k; } }
  return bestI;
}

/* Robust reverse-geocoder: try Open-Meteo → OSM Nominatim → fallback to coords */
async function reverseLabel(lat, lon){
  // 1) Open-Meteo reverse
  try{
    const r = await j(REV1(lat, lon));
    const f = r?.results?.[0];
    if (f){
      return [f.name, f.admin1, f.country].filter(Boolean).join(', ');
    }
  }catch(_){}

  // 2) OpenStreetMap Nominatim (needs a UA; browser provides one)
  try{
    const r = await j(REV2(lat, lon), { headers: { 'Accept-Language': 'en' }});
    const a = r?.address || {};
    const city = a.city || a.town || a.village || a.hamlet || a.suburb || a.county;
    const state = a.state || a.province || a.region;
    const country = a.country;
    const parts = [city, state, country].filter(Boolean);
    if (parts.length) return parts.join(', ');
  }catch(_){}

  // 3) Fallback
  return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
}

/* -------- Core rendering -------- */
async function render(lat, lon){
  el.err.textContent = '';
  el.place.textContent = 'Finding your city…';
  el.status.textContent = 'Loading…';
  el.pm.textContent = 'PM2.5: — µg/m³';
  el.time.textContent = '—';

  try{
    // Name the place first (so no “Your location”)
    const label = await reverseLabel(lat, lon);
    el.place.textContent = label;

    // Then air data
    const data = await j(AIR(lat, lon));
    const hours = data?.hourly?.time || [];
    const vals  = data?.hourly?.pm2_5 || [];
    if(!hours.length || !vals.length) throw new Error('No PM2.5 data here');

    const i  = indexClosestToNow(hours);
    const pm = Number(vals[i]);
    const cat= categorize(pm);

    el.status.textContent = `Air quality is ${cat}.`;
    el.pm.textContent     = `PM2.5: ${pm.toFixed(1)} µg/m³`;
    el.time.textContent   = `Closest hour: ${fmt(hours[i])}`;
    setTheme(cat);
  }catch(e){
    console.error(e);
    el.err.textContent = 'Could not load air data here.';
    el.status.textContent = '—';
  }
}

/* -------- Flows -------- */
// Geolocation (user click)
el.check.addEventListener('click', ()=>{
  el.err.textContent = '';
  el.place.textContent = 'Requesting location…';
  if(!navigator.geolocation){
    el.err.textContent = 'Geolocation not supported in this browser.';
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => render(pos.coords.latitude, pos.coords.longitude),
    _   => el.err.textContent = 'Location blocked or failed. Use the city search below.',
    { enableHighAccuracy:false, timeout:8000, maximumAge:60000 }
  );
});

// Manual city search
el.cityBtn.addEventListener('click', async ()=>{
  const q = el.city.value.trim();
  if(!q){ el.err.textContent = 'Type a city name.'; return; }
  el.err.textContent = ''; el.place.textContent = 'Searching city…'; el.status.textContent = 'Loading…';
  try{
    const g = await j(GEO(q));
    const f = g?.results?.[0];
    if(!f) throw new Error('City not found');
    const label = [f.name, f.admin1, f.country].filter(Boolean).join(', ');
    el.place.textContent = label;
    await render(f.latitude, f.longitude);
  }catch(e){
    console.error(e);
    el.err.textContent = 'City not found. Try another.';
    el.status.textContent = '—';
  }
});
document.getElementById('city').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') el.cityBtn.click();
});
</script>
</body>
</html>
