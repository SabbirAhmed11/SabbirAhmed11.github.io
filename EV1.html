<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BreatheEarth</title>
<style>
  /* full-screen layout */
  html, body {
    height: 100%;
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: background-image 0.8s ease-in-out;
  }

  h1 { font-size: clamp(2rem, 4vw, 3rem); margin: 0.4rem 0; }
  .sub { font-size: 1rem; opacity: 0.9; margin-bottom: 1.5rem; }
  .status { font-size: clamp(1.5rem, 3vw, 2rem); font-weight: 800; margin-bottom: 0.3rem; }
  .pm { font-weight: 700; opacity: 0.95; }
  .time { opacity: 0.8; font-size: 0.9rem; margin-top: 0.3rem; }
  .err { color: #ffbaba; font-weight: 700; margin-top: 1rem; }
  button {
    margin-top: 1rem;
    padding: 10px 18px;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    background: rgba(0,0,0,0.4);
    color: #fff;
    cursor: pointer;
  }
</style>
</head>
<body>
  <h1>BreatheEarth</h1>
  <p class="sub">The air you breathe connects us all.</p>
  <div id="place">Requesting location…</div>
  <div class="status" id="status">—</div>
  <div class="pm" id="pm">PM2.5: — µg/m³</div>
  <div class="time" id="time">—</div>
  <div class="err" id="err"></div>
  <button id="retry" style="display:none">Try again</button>

<script>
const airURL=(lat,lon)=>`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto`;
const revURL=(lat,lon)=>`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1&language=en`;

const el={p:place,status,pm,time,err,retry};

function setBackground(label){
  const base="./assets/images/EV/";
  const image={
    GOOD: "Good.png",
    BAD: "Bad.png",
    WORSE: "Worse.png",
    DEFAULT: "Home.png"
  }[label] || "Home.png";
  document.body.style.backgroundImage = `url('${base}${image}')`;
}

function category(pm){ return pm<=15?"GOOD":pm<=35?"BAD":"WORSE"; }
function formatTime(iso){
  try { return new Date(iso).toLocaleString([], {hour:'2-digit', minute:'2-digit', month:'short', day:'2-digit'}); }
  catch { return ""; }
}
async function getJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(r.status);
  return r.json();
}

async function load(lat,lon){
  el.err.textContent=""; el.status.textContent="Loading…";
  try{
    const rev = await getJSON(revURL(lat,lon));
    const name = rev.results?.[0];
    el.p.textContent = name ? [name.name,name.country].filter(Boolean).join(', ') : "Your location";

    const air = await getJSON(airURL(lat,lon));
    const pm = air.hourly.pm2_5.at(-1);
    const time = air.hourly.time.at(-1);
    const label = category(pm);

    el.status.textContent = `Air quality is ${label}`;
    el.pm.textContent = `PM2.5: ${pm.toFixed(1)} µg/m³`;
    el.time.textContent = `Updated ${formatTime(time)}`;
    setBackground(label);
  } catch (e) {
    console.error(e);
    el.err.textContent = "Could not load air data. Please try again.";
    el.status.textContent = "—";
    setBackground("DEFAULT");
  }
}

function askLocation(){
  el.err.textContent="";
  el.p.textContent="Requesting location…";
  el.retry.style.display="none";
  if(!navigator.geolocation){
    el.err.textContent="Geolocation not supported.";
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => load(pos.coords.latitude, pos.coords.longitude),
    () => {
      el.err.textContent="Location blocked. Please allow and reload.";
      el.retry.style.display="inline-block";
      setBackground("DEFAULT");
    }
  );
}

el.retry.onclick=askLocation;
askLocation();
</script>
</body>
</html>
